#include "mathfunc.h"
static inline int32_t abs32(int32_t a) {
    return a > 0 ? a : -a;
}

#define TRIANGLE_SIZE 256
//sin 0~PI/2
static q1516_t triangle_table[TRIANGLE_SIZE+1] = {
    0,     402,   804,   1206,  1608,  2010,  2412,  2814,  3215,  3617,  4018,
    4420,  4821,  5222,  5622,  6023,  6423,  6823,  7223,  7623,  8022,  8421,
    8819,  9218,  9616,  10013, 10410, 10807, 11204, 11600, 11995, 12390, 12785,
    13179, 13573, 13966, 14359, 14751, 15142, 15533, 15923, 16313, 16702, 17091,
    17479, 17866, 18253, 18638, 19024, 19408, 19792, 20175, 20557, 20938, 21319,
    21699, 22078, 22456, 22833, 23210, 23586, 23960, 24334, 24707, 25079, 25450,
    25820, 26189, 26557, 26925, 27291, 27656, 28020, 28383, 28745, 29105, 29465,
    29824, 30181, 30538, 30893, 31247, 31600, 31952, 32302, 32651, 32999, 33346,
    33692, 34036, 34379, 34721, 35061, 35400, 35738, 36074, 36409, 36743, 37075,
    37406, 37736, 38064, 38390, 38716, 39039, 39362, 39682, 40002, 40319, 40636,
    40950, 41263, 41575, 41885, 42194, 42501, 42806, 43110, 43412, 43712, 44011,
    44308, 44603, 44897, 45189, 45480, 45768, 46055, 46340, 46624, 46906, 47186,
    47464, 47740, 48015, 48288, 48558, 48828, 49095, 49360, 49624, 49886, 50146,
    50403, 50660, 50914, 51166, 51416, 51665, 51911, 52155, 52398, 52639, 52877,
    53114, 53348, 53581, 53811, 54040, 54266, 54491, 54713, 54933, 55152, 55368,
    55582, 55794, 56004, 56212, 56417, 56621, 56822, 57022, 57219, 57414, 57606,
    57797, 57986, 58172, 58356, 58538, 58718, 58895, 59070, 59243, 59414, 59583,
    59749, 59913, 60075, 60235, 60392, 60547, 60700, 60850, 60998, 61144, 61288,
    61429, 61568, 61705, 61839, 61971, 62100, 62228, 62353, 62475, 62596, 62714,
    62829, 62942, 63053, 63162, 63268, 63371, 63473, 63571, 63668, 63762, 63854,
    63943, 64030, 64115, 64197, 64276, 64353, 64428, 64501, 64571, 64638, 64703,
    64766, 64826, 64884, 64939, 64992, 65043, 65091, 65136, 65179, 65220, 65258,
    65294, 65327, 65358, 65386, 65412, 65436, 65457, 65475, 65491, 65505, 65516,
    65524, 65531, 65534,1<<16

};

q1516_t sqrt1516(q1516_t x) {
    // newton方による解法
    const q1516_t eps = 1 << 2;
    const size_t limit = 8;  //試行回数の制限
    size_t cnt;
    q1516_t now = 1 << 16, next = 0;
    q3132_t f;
    q1516_t g;
    for (cnt = 0; cnt < limit; cnt++) {
        f = (((q3132_t)now * now) >> 16) - x;
        g = 2 * now;
        next = now - ((f << 16) / g);
        if (abs32(now - next) < eps) {
            return next;
        } else {
            now = next;
        }
    }
    return next;
}

q1516_t exp1516(q1516_t x) {
    //テイラー展開
    const size_t limit = 8;  //試行制限
    size_t cnt;
    int32_t fact = 1;
    //第一項と第二項の計算
    q1516_t pow = x;
    q1516_t now = pow + (1 << 16);
    //第n項の計算
    for (cnt = 2; cnt < limit; cnt++) {
        fact *= cnt;
        pow = ((q3132_t)pow * x) >> 16;
        now += pow / fact;
    }
    return now;
}

q1516_t omega1516(q1516_t rad) {
    const static q1516_t INV_2PI = 10430;  // 1/2PI <<16
    return ((q3132_t)rad * INV_2PI) >> 16;
}

q1516_t sin1516(q1516_t x){
    const static q1516_t* table= triangle_table; 
    const uint16_t omega =omega1516(x)&0xffff;
    const uint16_t mode = omega>>14;
    const bool sign = mode&0b10,inv = mode&0b01;
    

    if (sign){

    }else{

    }

}